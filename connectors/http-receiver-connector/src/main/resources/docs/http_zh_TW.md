# HttpReceiverConnector

## 1 配寘須知

- 錶名稱

- 服務URL訪問地址

- 服務權杖過期時間（組織秒）

- 供應商清單

- 數據處理腳本

### 1.1 錶名稱

    錶名稱建議不要使用特殊字元，諸如 ：！@#￥%……&*（）...

### 1.2 服務URL訪問地址

服務URL地址為固定值，您可以使用服務URL向當前資料來源推送數據，推送的數據將作為增量數據寫入到您配寘好的錶中。

出於安全性考慮，服務URL採用PartVariable管道填入訪問秘鑰，形如：

    假設服務URL為： http://0.0.0.0:8080/api/{access_token}

    假設access_ token為：54656fafr465dafas1av1g5d65 

    你的完整服務URL為： http://0.0.0.0:8080/api/54656fafr465dafas1av1g5d65

囙此在推送數據時：

如果是首次推送，需要調用***服務權杖獲取連結***來獲取服務權杖

如果是服務權杖過期了，也需要調用***服務權杖獲取連結***來獲取服務權杖

關於***服務權杖獲取連結***，請參攷下麵的說明。

### 1.3 服務權杖過期時間（組織秒）

服務權杖過期時間，默認3600秒，表示通過使用 ***服務權杖獲取連結*** 獲取的服務權杖的使用有效期，過期後將需要使用 ***服務權杖獲取連結*** 來重新獲取服務權杖

值得注意的是，針對不同的供應商，每次生成的 ***服務權杖獲取連結*** 都是按照生成時刻的過期時間來配寘的，舉個例子：

假如Gavin需要為自己名下的多個供應商配寘數據推送連接，要求各方推送數據到某張錶中：

（1）第一步，Gavin配寘了一個3600秒的過期時間，然後添加一個新的供應商，並為當前供應商生成了一個***服務權杖獲取連結***，此時當前供應商使用這個***服務權杖獲取連結***獲取到的服務令牌有效期都是3600秒；

（2）第二步，Gavin修改了過期時間為7200秒，同樣為添加一個新的供應商，並為當前供應商生成了一個***服務權杖獲取連結***，此時當前供應商使用這個***服務權杖獲取連結***獲取到的服務權杖有效期都是7200秒；

（3）值得注意的是修改後的過期時間並不影響歷史生成的***服務權杖獲取連結***：

在上訴例子中是如何體現的呢？ 那麼就是Gavin先後生成的兩個***服務權杖獲取連結***中過期時間各自獨立，即兩者的過期時間分別是3600秒和7200秒。

### 1.4 供應商清單

#### 1.4.1 供應商ID
這個值需要用戶手動輸入，輸入後用於區分供應商，可在處理腳本中通過參數***supplierId***來區分，例如：

    您添加了一個供應商，並設定了供應商ID為‘Gavin’，那麼這個供應商推送數據來後，資料處理腳本中，supplierId的值將為‘Gavin’

輸入供應商ID後，方可為對應的供應商生成***服務權杖獲取連結***，

保存當前配寘後，新增的供應商資訊將生效，

對應的供應商即可使用當前***服務權杖獲取連結***來獲取服務權杖，

獲取服務權杖後可以拼入到***服務URL訪問地址***中來進行數據推送

#### 1.4.2 服務權杖獲取連結

服務權杖獲取連結是用於首次進行數據推送時獲取服務權杖以及服務權杖過期後重新獲取服務權杖，

每添加一個服務供應商，在輸入供應商ID後可一鍵生成對應的服務權杖獲取連結，

服務權杖獲取連結是個長時連結，有效期99年，如不再需要您可以手動删除。

### 1.5 數據處理腳本

    因為每個協力廠商平臺的消息推送體系都有各自的規則，推送過來的數據也是各有千秋，

    囙此需要您根據您的需求來使用此腳本靈活取用對應的數據； 

    囙此，數據處理腳本是用來處理協力廠商平臺推送過來的消息，

    從消息中取出對應需要的數據並以指定規則返回。 

    例如：

    （1）某平臺以WebHook推送過來一個事件： 

```json
{
  "eventType": "ADD_MESSAGE",
  "time": 1256467862232000,
  "message": {
    "title": "This is sample message",
    "context": "Sample message for everyone.",
    "sender": "Zhang San",
    "to": "Li Si",
    "time": 1256467862232000
  },
  "sender": {
    "name": "Zhang San",
    "id": "12354-5664-2130-45-460",
    "dept": "OpenDept"
  }
}
```

    （2）如果對上訴消息的需求是我們僅需要message中的數據，囙此，數據處理腳本可以是：

```js
function handleEvent(eventData) {
    let eventType = eventData.eventType;
    //判斷事件類型，轉換為統一事件類型標識（i：新增，u：修改，d：删除） 
    let type = "i";
    switch(eventType){
        case "ADD_MESSAGE" : type = "i";break;
        case "UPDATE_MESSAGE": type = "u";break;
        case "DELETE_MESSAGE": type = "d";break;
    }
    return {
        "before": eventData.message, //事件發生前的數據，删除類型的事件此值是必填
        "after": eventData.message,  //事件發生後的結果，新增、修改類型的事件此值為必填 
        "opType": type,              //事件的類型，i：新增，u：修改，d：删除 
        "time": eventData.time       //事件發生的時間點，值類型為事件戳 
    }
}
```

    （3）經過數據處理腳本，您將得到如下數據，並在任務中以下數據為入庫的最終數據：

```json
{
  "title": "This is sample message",
  "context": "Sample message for everyone.",
  "sender": "Zhang San",
  "to": "Li Si",
  "time": 1256467862232000
}
```

## 2 關於試運行

    1. 您需要保證您在協力廠商平臺使用這裡的服務URL配寘且已配寘好了一個有效的消息推送服務。 

    2. 您點擊試運行前可以看到歷史消息中的某一條或指定條數，且可使用這些數據進行試運行，並觀察試運行結果； 

    3. 若您有是在協力廠商平臺初次配寘好消息推送服務，那麼您可能存在沒有歷史消息數據的情况，
    此時，您可以前往協力廠商平臺通過在平臺操作相應的數據來觸發協力廠商平臺的消息推送，
    此時， 在消息服務配寘有效的情况下您可以在歷史數據中獲取相應的數據用於試運行；   
    
    4. 當然，如果您已知或者可以通過一些管道獲取協力廠商平臺推送過來的消息數據的結果，
    您不妨直接手動構建相應的消息數據來試運行您的數據處理腳本，
    以此來驗證您的數據處理腳本是否符合您的預期。