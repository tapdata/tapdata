name: "Gemini AI Code Review"

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Gemini key exists
        shell: bash
        run: |
          if [ -z "${{ secrets.GEMINI_AI_CODE_REVIEW_JACKIN }}" ]; then
            echo "‚ùå Secret GEMINI_AI_CODE_REVIEW_JACKIN is empty or not configured"
            exit 1
          fi
          echo "‚úÖ Gemini key is present"

      - name: Build PR diff (with excludes)
        id: pr_diff
        shell: bash
        env:
          HEAD_REF: "${{ github.event.pull_request.head.ref }}"
          BASE_REF: "${{ github.event.pull_request.base.ref }}"
        run: |
          set -euo pipefail

          git fetch origin "${BASE_REF}:${BASE_REF}"
          git fetch origin "${HEAD_REF}:${HEAD_REF}"

          # ÁîüÊàê diffÔºöÊéíÈô§‰∏çÈúÄË¶Å review ÁöÑÊñá‰ª∂
          git diff "origin/${BASE_REF}...origin/${HEAD_REF}" \
            -- . \
            ":(exclude)package-lock.json" \
            ":(exclude)yarn.lock" \
            ":(exclude)dist/**" \
            ":(exclude)build/**" \
            ":(exclude)**/*.md" \
            ":(exclude)**/*.snap" \
            ":(exclude)**/*.min.*" \
            > diff.txt

          if [ ! -s diff.txt ]; then
            echo "No diff to review (after excludes)."
            {
              echo "diff<<EOF"
              echo ""
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Èò≤Ê≠¢ diff Ë∂ÖÂ§ßÔºöÊà™Êñ≠ÔºàÊåâÈúÄË∞ÉÂ§ß/Ë∞ÉÂ∞èÔºâ
          MAX_BYTES=$((800000))  # ~0.8MB
          SIZE=$(wc -c < diff.txt)
          if [ "$SIZE" -gt "$MAX_BYTES" ]; then
            head -c "$MAX_BYTES" diff.txt > diff_truncated.txt
            mv diff_truncated.txt diff.txt
            echo "[WARN] diff too large (${SIZE} bytes), truncated to ${MAX_BYTES} bytes." >&2
          fi

          {
            echo "diff<<EOF"
            cat diff.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Gemini review & comment to PR (Gemini API v1)
        shell: bash
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_AI_CODE_REVIEW_JACKIN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DIFF: ${{ steps.pr_diff.outputs.diff }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
            import os, json, urllib.request, textwrap
            
            gemini_key = os.environ["GEMINI_API_KEY"]
            repo = os.environ["REPO"]
            pr_number = os.environ["PR_NUMBER"]
            diff = os.environ.get("DIFF", "")
          
          if not diff.strip():
            print("Empty diff, skip.")
            raise SystemExit(0)
          
          # ‚úÖ ÈÄâÊã©‰Ω† key Â∑≤ËØÅÊòéÂèØÁî®ÁöÑÊ®°ÂûãÔºà‰ªé‰Ω† v1/models ËæìÂá∫ÈáåÊù•Ôºâ
            MODEL = "models/gemini-2.5-flash"
            
            prompt = f"""
            ‰Ω†ÊòØËµÑÊ∑±‰ª£Á†ÅÂÆ°Êü•ÂëòÔºåËØ∑Áî®‰∏≠ÊñáÂØπËøôÊ¨° PR ÁöÑ diff ÂÅö Code Review„ÄÇ
            ËæìÂá∫ÁªìÊûÑÂøÖÈ°ª‰∏•Ê†ºÊåâ‰ª•‰∏ãÊ†ºÂºèÔºö
            1) ÊÄª‰ΩìÁªìËÆ∫ÔºàÈ£éÈô©Á≠âÁ∫ßÔºö‰Ωé/‰∏≠/È´òÔºâ
            2) ÂøÖÈ°ª‰øÆÂ§çÔºàÈòªÂ°ûÂêàÂπ∂ÔºâÔºöÊåâÊù°ÂàóÂá∫ÔºåËØ¥ÊòéÂéüÂõ†ÔºåÂπ∂ÁªôÂá∫ÂèØÊâßË°å‰øÆÊîπÂª∫ËÆÆ
            3) Âª∫ËÆÆ‰ºòÂåñÔºà‰∏çÈòªÂ°ûÔºâÔºöÊåâÊù°ÂàóÂá∫
            4) ÊΩúÂú® Bug/ËæπÁïåÊù°‰ª∂ÔºöÊåâÊù°ÂàóÂá∫
            5) ÊµãËØïÂª∫ËÆÆÔºöÈúÄË¶ÅË°•Âì™‰∫õÂçïÊµã/ÈõÜÊàêÊµãËØï/ÂõûÂΩíÁÇπ
            6) ÂÆâÂÖ®‰∏éÂêàËßÑÔºöÂ¶ÇÊûúÂèëÁé∞ÂØÜÈí•„ÄÅÊùÉÈôê„ÄÅÊó•ÂøóÊ≥ÑÈú≤„ÄÅ‰æùËµñÈ£éÈô©ÔºåÂøÖÈ°ªÊåáÂá∫
            
            È¢ùÂ§ñË¶ÅÊ±ÇÔºö
          - Â∞ΩÈáèÂºïÁî®Êñá‰ª∂Ë∑ØÂæÑ‰∏é diff ÁâáÊÆµÂÆö‰ΩçÈóÆÈ¢ò
          - Â¶ÇÊûú‰ø°ÊÅØ‰∏çË∂≥ÔºåÊòéÁ°ÆÂÜô‚ÄúÈúÄË¶ÅÊõ¥Â§ö‰∏ä‰∏ãÊñá‚ÄùÁöÑÁÇπ
            
            ‰∏ãÈù¢ÊòØ diffÔºö
            {diff}
            """.strip()
          
          url = f"https://generativelanguage.googleapis.com/v1/{MODEL}:generateContent?key={gemini_key}"
            
            payload = {
          "contents": [{
            "role": "user",
            "parts": [{"text": prompt}]
          }],
          "generationConfig": {
            "temperature": 0.2,
            "topP": 0.9,
            "maxOutputTokens": 2048
          }
          }
          
            req = urllib.request.Request(
            url,
            data=json.dumps(payload).encode("utf-8"),
          headers={"Content-Type": "application/json"},
            method="POST"
            )
          
          try:
            with urllib.request.urlopen(req, timeout=180) as resp:
              data = json.loads(resp.read().decode("utf-8"))
          except Exception as e:
            raise SystemExit(f"Gemini call failed: {e}")
          
          text = ""
          cands = data.get("candidates", [])
          if cands:
            parts = cands[0].get("content", {}).get("parts", [])
            text = "".join(p.get("text", "") for p in parts).strip()
          
          if not text:
            text = f"(Gemini returned empty response)\nRaw: {json.dumps(data)[:1200]}"
          
          comment_body = "## ü§ñ Gemini Code Review\n\n" + text
          
          # GitHub PR comment API
            gh_url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
            gh_req = urllib.request.Request(
            gh_url,
          data=json.dumps({"body": comment_body}).encode("utf-8"),
            headers={
          "Authorization": f"token {os.environ['GITHUB_TOKEN']}",
          "Accept": "application/vnd.github+json",
          "Content-Type": "application/json"
          },
            method="POST"
            )
          
          with urllib.request.urlopen(gh_req, timeout=60) as resp:
            print("Comment created:", resp.status)
            PY