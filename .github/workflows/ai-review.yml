name: "Gemini AI Code Review"

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Gemini key exists
        shell: bash
        run: |
          if [ -z "${{ secrets.GEMINI_AI_CODE_REVIEW_JACKIN }}" ]; then
            echo "❌ Secret GEMINI_AI_CODE_REVIEW_JACKIN is empty or not configured"
            exit 1
          fi
          echo "✅ Gemini key is present"

      - name: Build PR diff (with excludes)
        id: pr_diff
        shell: bash
        env:
          HEAD_REF: "${{ github.event.pull_request.head.ref }}"
          BASE_REF: "${{ github.event.pull_request.base.ref }}"
        run: |
          set -euo pipefail

          git fetch origin "${BASE_REF}:${BASE_REF}"
          git fetch origin "${HEAD_REF}:${HEAD_REF}"

          git diff "origin/${BASE_REF}...origin/${HEAD_REF}" \
            -- . \
            ":(exclude)package-lock.json" \
            ":(exclude)yarn.lock" \
            ":(exclude)dist/**" \
            ":(exclude)build/**" \
            ":(exclude)**/*.md" \
            ":(exclude)**/*.snap" \
            ":(exclude)**/*.min.*" \
            > diff.txt

          if [ ! -s diff.txt ]; then
            echo "No diff to review (after excludes)."
            {
              echo "diff<<EOF"
              echo ""
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          MAX_BYTES=$((900000))
          SIZE=$(wc -c < diff.txt)
          if [ "$SIZE" -gt "$MAX_BYTES" ]; then
            head -c "$MAX_BYTES" diff.txt > diff_truncated.txt
            mv diff_truncated.txt diff.txt
            echo "[WARN] diff too large (${SIZE} bytes), truncated to ${MAX_BYTES} bytes." >&2
          fi

          {
            echo "diff<<EOF"
            cat diff.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Gemini Code Review (flash)
        uses: rubensflinco/gemini-code-review-action@1.0.5
        with:
          gemini_api_key: ${{ secrets.GEMINI_AI_CODE_REVIEW_JACKIN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          github_repository: ${{ github.repository }}
          github_pull_request_number: ${{ github.event.pull_request.number }}
          git_commit_hash: ${{ github.event.pull_request.head.sha }}

          model: "gemini-1.5-flash"

          pull_request_diff: |-
            ${{ steps.pr_diff.outputs.diff }}

          pull_request_chunk_size: "3500"
          temperature: "0.2"
          top_p: "0.9"
          max_tokens: "2048"
          log_level: "INFO"
          extra_prompt: |-
            用中文进行 Code Review。输出：
            1) 总体结论（风险等级：低/中/高）
            2) 必须修复（阻塞合并）
            3) 建议优化（不阻塞）
            4) 潜在 Bug/边界条件
            5) 测试建议
            6) 安全与合规（密钥/权限/日志泄露/依赖风险）

      - name: List models (Gemini API v1)
        shell: bash
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_AI_CODE_REVIEW_JACKIN }}
        run: |
          curl -s "https://generativelanguage.googleapis.com/v1/models?key=${GEMINI_API_KEY}" | head -c 4000